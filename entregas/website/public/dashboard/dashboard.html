<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyclus | Dashboards</title>

    <!-- <link rel="stylesheet" href="./../css/dashboards.css"> -->
    <!-- <link rel="stylesheet" href="./../css/estilo.css" /> -->
    <link rel="stylesheet" href="./../css/slide.css">
    <link rel="stylesheet" href="./../css/dashboard.css">
    <link rel="stylesheet" href="./../css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">

    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>
    <header class="slide">
        <span id="b_usuario"></span>
        <ul class="slide-header">
            <li class="slide-header-item">
                <a href="./dashboard.html"><img src="../assets/icon/dashboard_white.png">Dashboard</a>
            </li>
            <li class="slide-header-item">
                <a href="bob.html"><img src="../assets/icon/chat.svg">Chat</a>
            </li>
            <li class="slide-header-item">
                <a onclick="limparSessao()"><img src="../assets/icon/sair.svg">Sair</a>
            </li>
        </ul>
        <img class="cyclus_logo" src="../assets/cyclus.png">
    </header>

    <section class="dash dash-text">
        <div class="dash-divs">
            <ul class="dash-kpis">
                <li class="dash-kpis-item" id="dash_freezer_1">
                </li>
                <li class="dash-kpis-item">
                    <span class="dash-kpi-title">Freezer com Maior Incidência de Alertas</span>
                    <span class="dash-kpi-number" id="kpi_incidencia"></span>
                </li>
                <li class="dash-kpis-item">
                    <span class="dash-kpi-title">Percentual de Alertas por Semana</span>
                    <span class="dash-kpi-number" id="kpi_percentual"></span>
                </li>
                <li class="dash-kpis-item">
                    <span class="dash-kpi-title">Total de Alertas Ativos</span>
                    <span class="dash-kpi-number" id="kpi_ativo"></span>
                </li>
            </ul>
        </div>
        <div class="dash-divs">
            <ul class="dash-kpis">
                <li class="dash-kpis-item">
                    <h3>Temperatura do freezer</h3>
                    <canvas id="graficoSensores" class="myChartCanvas_rankingTags"></canvas>
                </li>
                <li class="dash-kpis-item">
                    <h3>Histórico de alertas</h3>
                    <table id="tabelaAlertas">
                        <thead>
                            <tr>
                                <th>Freezer</th>
                                <th>Temperatura</th>
                                <th>Horário</th>
                            </tr>
                        </thead>
                        <tbody id="corpoAlertas"></tbody>
                    </table>
                </li>
            </ul>
        </div>
    </section>
</body>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let proximaAtualizacao;
    let updateKpi1;
    let updateKpi2;
    let updateKpi3;

    let historicoAlertas = [];
    const LIMITE_ALERTAS = 5;

    // Inicia o gráfico ao carregar a página
    window.onload = function () {
        obterDadosSensor();
        obterDadosFreezers();
        obterDadosKpi1();
        obterDadosKpi2();
        obterDadosKpi3();
    }

    async function obterDadosSensor() {
        try {
            const response = await fetch(`/medidas/obterdados`, { cache: 'no-store' });

            if (response.ok) {
                const resposta = await response.json();
                resposta.reverse();
                plotarGrafico(resposta);
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }

        } catch (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        }
    }

    function plotarGrafico(resposta) {
        console.log('iniciando plotagem do gráfico...');

        let labels = [];

        let dados = {
            labels: labels,
            datasets: [{
                label: 'Freezer 1',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                borderWidth: 3,
                pointBorderWidth: 0,
                tension: 0.3,
            }]
        };

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            let registro1 = resposta[i];
            labels.push(registro1.freezer_dataHora);
            dados.datasets[0].data.push(registro1.freezer_tempAtual);
        }

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`graficoSensores`),
            config
        );
        setTimeout(() => atualizarGrafico(dados, myChart), 5000);
    }

    function atualizarGrafico(dados, myChart) {
        fetch(`/medidas/tempo-real`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {
                    if (novoRegistro[0].freezer_dataHora == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("---------------------------------------------------------------")
                    } else {
                        dados.labels.shift();
                        dados.labels.push(novoRegistro[0].freezer_dataHora);

                        dados.datasets[0].data.shift();

                        dados.datasets[0].data.push(novoRegistro[0].freezer_tempAtual);

                        verificarAlerta(novoRegistro)
                        plotarTabelaFreezer(novoRegistro)

                        myChart.update();
                    }
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 5000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 5000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Verifica se existe alerta
    function verificarAlerta(registro) {

        let temp = Number(registro[0].freezer_tempAtual);
        let nome = `Freezer ${registro[0].freezer_id}`;
        let horario = registro[0].freezer_dataHora;

        if (temp < 2 || temp > 7) {
            registrarAlerta(nome, temp, horario);
        }
    }

    // Registrar o alerta
    function registrarAlerta(sensor, temperatura, horario) {

        temperatura = Number(temperatura);
        historicoAlertas.push({
            sensor: sensor,
            temperatura: temperatura.toFixed(1) + " °C",
            horario: horario
        });

        if (historicoAlertas.length > LIMITE_ALERTAS) {
            historicoAlertas.shift();
        }
        atualizarTabelaAlertas();
    }

    function atualizarTabelaAlertas() {
        const corpo = document.getElementById("corpoAlertas");
        corpo.innerHTML = '';

        historicoAlertas.forEach(alerta => {
            const linha = document.createElement("tr");

            const tdSensor = document.createElement("td");
            tdSensor.innerText = alerta.sensor;

            const tdTemp = document.createElement("td");
            tdTemp.innerText = alerta.temperatura;

            const tdHoras = document.createElement("td");
            tdHoras.innerText = alerta.horario;

            linha.appendChild(tdSensor);
            linha.appendChild(tdTemp);
            linha.appendChild(tdHoras);

            corpo.appendChild(linha);
        });
    }

    async function obterDadosFreezers() {
        try {
            const response = await fetch(`/medidas/dadosfreezer`);
            if (response.ok) {
                const r = await response.json();
                plotarTabelaFreezer(r);
                verificarAlerta(r);
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        } catch (error) {
            console.error(`Erro na obtenção dos dados p/ Freezer: ${error.message}`);
        }
    }

    function plotarTabelaFreezer(r) {
        let status = ``;
        if (r[0].freezer_alerta == 1) {
            status = `Alerta`
            dash_freezer_1.className = `dash-kpis-item-alert`
            dash_freezer_1.innerHTML = `
                <span class="dash-kpi-title">Freezer ${r[0].freezer_id}</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">${r[0].freezer_corredor}</span>
                <span class="dash-kpi-detalhes">${r[0].freezer_tempAtual}ºC às ${r[0].freezer_dataHora}</span>
            `
        } else {
            status = `Normal`
            dash_freezer_1.className = `dash-kpis-item`
            dash_freezer_1.innerHTML = `
                <span class="dash-kpi-title">Freezer ${r[0].freezer_id}</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">${r[0].freezer_corredor}</span>
                <span class="dash-kpi-detalhes">${r[0].freezer_tempAtual}ºC às ${r[0].freezer_dataHora}</span>
            `
        }
    }

    async function obterDadosKpi1() {
        try {
            const response = await fetch(`/medidas/obterdadoskpi1`, { cache: 'no-store' });

            if (response.ok) {
                const resposta = await response.json();
                kpi_incidencia.innerHTML = `
                Freezer: ${resposta[0].id_freezer} Total: ${resposta[0].total_alertas}
            `;
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }

        } catch (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        }

        updateKpi1 = setTimeout(() => obterDadosKpi1(), 5000);
    }

    async function obterDadosKpi2() {
        try {
            const response = await fetch(`/medidas/obterdadoskpi2`, { cache: 'no-store' });

            if (response.ok) {
                const resposta = await response.json();
                kpi_percentual.innerHTML = `
                ${resposta[0].percentual_alertas}
            `;
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }

        } catch (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        }

        updateKpi2 = setTimeout(() => obterDadosKpi2(), 5000);
    }

    async function obterDadosKpi3() {
        try {
            const response = await fetch(`/medidas/obterdadoskpi3`, { cache: 'no-store' });

            if (response.ok) {
                const resposta = await response.json();
                kpi_ativo.innerHTML = `
                ${resposta[0].total_freezers_com_alerta_ativo}
            `;
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }

        } catch (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        }
        updateKpi3 = setTimeout(() => obterDadosKpi3(), 5000);
    }
</script>