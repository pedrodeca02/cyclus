<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyclus | Dashboards</title>

    <!-- <link rel="stylesheet" href="./../css/dashboards.css"> -->
    <!-- <link rel="stylesheet" href="./../css/estilo.css" /> -->
    <link rel="stylesheet" href="./../css/slide.css">
    <link rel="stylesheet" href="./../css/dashboard.css">
    <link rel="stylesheet" href="./../css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">

    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>
    <header class="slide">
        <span id="b_usuario"></span>
        <ul class="slide-header">
            <li class="slide-header-item">
                <a href="./dashboard.html"><img src="../assets/icon/dashboard_white.png">Dashboard</a>
            </li>
            <li class="slide-header-item">
                <a href="bob.html"><img src="../assets/icon/chat.svg">Chat</a>
            </li>
            <li class="slide-header-item">
                <a onclick="limparSessao()"><img src="../assets/icon/sair.svg">Sair</a>
            </li>
        </ul>
        <img class="cyclus_logo" src="../assets/cyclus.png">
    </header>

    <section class="dash dash-text">
        <div class="dash-divs">
            <p>Freezers</p>
            <ul class="dash-kpis">
                <li class="dash-kpis-item" id="dash_freezer_1"></li>
                <li class="dash-kpis-item" id="dash_freezer_2"></li>
                <li class="dash-kpis-item" id="dash_freezer_3"></li>
                <li class="dash-kpis-item" id="dash_freezer_4"></li>
            </ul>
        </div>
        <div class="dash-divs">
            <ul class="dash-kpis">
                <li class="dash-kpis-item">
                    <span class="dash-kpi-title">KPI1</span>
                    <span class="dash-kpi-number" id="kpi_totalduvida"></span>
                </li>
                <li class="dash-kpis-item">
                    <span class="dash-kpi-title">KPI1</span>
                    <span class="dash-kpi-number" id="kpi_totalpost"></span>
                </li>
                <li class="dash-kpis-item">
                    <span class="dash-kpi-title">KPI1</span>
                    <span class="dash-kpi-number" id="kpi_duvidasporpost"></span>
                </li>
                <li class="dash-kpis-item">
                    <span class="dash-kpi-title">KPI1</span>
                    <span class="dash-kpi-number" id="kpi_postporuser"></span>
                </li>
            </ul>
        </div>
        <div class="dash-divs">
            <ul class="dash-kpis">
                <li class="dash-kpis-item">
                    <h3>Todos os freezers</h3>
                    <canvas id="graficoSensores" class="myChartCanvas_rankingTags"></canvas>
                </li>
                <li class="dash-kpis-item">
                    <h3>Alerta mais recentes</h3>
                    <table id="tabelaAlertas">
                        <thead>
                            <tr>
                                <th>Freezer</th>
                                <th>Temperatura</th>
                                <th>Horário</th>
                            </tr>
                        </thead>
                        <tbody id="corpoAlertas"></tbody>
                    </table>
                </li>
            </ul>
        </div>
    </section>
</body>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let proximaAtualizacao;

    let historicoAlertas = [];
    const LIMITE_ALERTAS = 5;

    let chartSensores;
    let dadosSensores = {
        labels: [],
        sensor2: [],
        sensor3: [],
        sensor4: []
    };

    // Inicia o gráfico ao carregar a página
    window.onload = function () {
        obterDadosSensor();
        obterDadosFreezers();
    }

    // Gerar os dados mockados
    function gerarDados() {
        // Dados mockado com math random
        let sensor2 = Math.random() * 7 + 1;
        let sensor3 = Math.random() * 7 + 1;
        let sensor4 = Math.random() * 7 + 1;

        return {
            sensor2: sensor2.toFixed(1),
            sensor3: sensor3.toFixed(1),
            sensor4: sensor4.toFixed(1)
        }
    }

    function obterDadosSensor() {
        fetch(`/medidas/obterdados`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (sensor1) {
                    sensor1.reverse();
                    plotarGrafico(sensor1);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(sensor1) {
        console.log('iniciando plotagem do gráfico...');

        let labels = [];

        let dados = {
            labels: labels,
            datasets: [{
                label: 'Freezer 1',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                borderWidth: 3,
                pointBorderWidth: 0,
                tension: 0.3,
            },
            {
                label: 'Freezer 2',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                borderWidth: 2,
                pointBorderWidth: 0,
                tension: 0.3,
            },
            {
                label: 'Freezer 3',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                borderWidth: 2,
                pointBorderWidth: 0,
                tension: 0.3,
            },
            {
                label: 'Freezer 4',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                borderWidth: 2,
                pointBorderWidth: 0,
                tension: 0.3,
            }]
        };

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < sensor1.length; i++) {
            let registro1 = sensor1[i];
            labels.push(registro1.freezer_dataHora);
            dados.datasets[0].data.push(registro1.freezer_tempAtual);
        }

        for (i = 0; i < 5; i++) {
            let registro2 = gerarDados();
            let registro3 = gerarDados();
            let registro4 = gerarDados();

            dados.datasets[1].data.push(registro2.sensor2);
            dados.datasets[2].data.push(registro3.sensor3);
            dados.datasets[3].data.push(registro4.sensor4);
        }

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`graficoSensores`),
            config
        );
        setTimeout(() => atualizarGrafico(dados, myChart), 5000);
    }

    function atualizarGrafico(dados, myChart) {
        fetch(`/medidas/tempo-real`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {
                    obterDadosSensor();
                    if (novoRegistro[0].freezer_dataHora == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("---------------------------------------------------------------")
                    } else {
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].freezer_dataHora); // incluir um novo momento
                        let dadosmocados = gerarDados();

                        dados.datasets[0].data.shift();
                        dados.datasets[1].data.shift();
                        dados.datasets[2].data.shift();
                        dados.datasets[3].data.shift();

                        dados.datasets[0].data.push(novoRegistro[0].freezer_tempAtual);
                        dados.datasets[1].data.push(dadosmocados.sensor2);
                        dados.datasets[2].data.push(dadosmocados.sensor3);
                        dados.datasets[3].data.push(dadosmocados.sensor4);

                        let registro = novoRegistro[0];
                        verificarAlerta(registro, dadosmocados)
                        plotarTabelaFreezer(novoRegistro, dadosmocados)
                        myChart.update();
                    }
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 5000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 5000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Verifica se existe alerta
    function verificarAlerta(registro, dadosmocados) {
        let sensores = [
            { nome: "Freezer 1", valor: Number(registro.freezer_tempAtual) },
            { nome: "Freezer 2", valor: Number(dadosmocados.sensor2) },
            { nome: "Freezer 3", valor: Number(dadosmocados.sensor3) },
            { nome: "Freezer 4", valor: Number(dadosmocados.sensor2) }
        ];

        for (let x = 0; x < sensores.length; x++) {
            let temp = sensores[x].valor;
            let nome = sensores[x].nome;

            if (temp < 2 || temp > 7) {
                registrarAlerta(nome, temp, registro);
            }
        }
    }

    // Registrar o alerta
    function registrarAlerta(sensor, temperatura, registro) {

        temperatura = Number(temperatura);
        historicoAlertas.push({
            sensor: sensor,
            temperatura: temperatura.toFixed(1) + " °C",
            horario: registro.freezer_dataHora
        });

        if (historicoAlertas.length > LIMITE_ALERTAS) {
            historicoAlertas.shift();
        }
        atualizarTabelaAlertas();
    }

    // Atualiza a tabela de forma automática
    function atualizarTabelaAlertas() {
        const corpo = document.getElementById("corpoAlertas");
        corpo.innerHTML = '';

        historicoAlertas.forEach(alerta => {
            const linha = document.createElement("tr");

            const tdSensor = document.createElement("td");
            tdSensor.innerText = alerta.sensor;

            const tdTemp = document.createElement("td");
            tdTemp.innerText = alerta.temperatura;

            const tdHoras = document.createElement("td");
            tdHoras.innerText = alerta.horario;

            linha.appendChild(tdSensor);
            linha.appendChild(tdTemp);
            linha.appendChild(tdHoras);

            corpo.appendChild(linha);
        });
    }

    function obterDadosFreezers() {
        fetch(`/medidas/dadosfreezer`).then(function (response) {
            if (response.ok) {
                response.json().then(function (r) {
                    let dadosmocados = gerarDados();
                    plotarTabelaFreezer(r, dadosmocados);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ Freezer: ${error.message}`);
            });
    }

    function plotarTabelaFreezer(r, dadosmocados) {
        let status = ``;
        if (r[0].freezer_alerta == 1) {
            status = `Alerta`
            dash_freezer_1.className = `dash-kpis-item-alert`
            dash_freezer_1.innerHTML = `
                <span class="dash-kpi-title">Freezer ${r[0].freezer_id}</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">${r[0].freezer_corredor}</span>
                <span class="dash-kpi-detalhes">${r[0].freezer_tempAtual}ºC às ${r[0].freezer_dataHora}</span>
            `
        } else {
            status = `Normal`
            dash_freezer_1.className = `dash-kpis-item`
            dash_freezer_1.innerHTML = `
                <span class="dash-kpi-title">Freezer ${r[0].freezer_id}</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">${r[0].freezer_corredor}</span>
                <span class="dash-kpi-detalhes">${r[0].freezer_tempAtual}ºC às ${r[0].freezer_dataHora}</span>
            `
        }

        if (dadosmocados.sensor2 > 7 || dadosmocados.sensor2 < 2) {
            status = `Alerta`
            dash_freezer_2.className = `dash-kpis-item-alert`
            dash_freezer_2.innerHTML = `
                <span class="dash-kpi-title">Freezer 2</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">Corredor 2</span>
                <span class="dash-kpi-detalhes">${dadosmocados.sensor2}ºC às ${r[0].freezer_dataHora}</span>
            `
        } else {
            status = `Normal`
            dash_freezer_2.className = `dash-kpis-item`
            dash_freezer_2.innerHTML = `
                <span class="dash-kpi-title">Freezer 2</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">Corredor 2</span>
                <span class="dash-kpi-detalhes">${dadosmocados.sensor2}ºC às ${r[0].freezer_dataHora}</span>
            `
        }
        if (dadosmocados.sensor3 > 7 || dadosmocados.sensor3 < 2) {
            status = `Alerta`
            dash_freezer_3.className = `dash-kpis-item-alert`
            dash_freezer_3.innerHTML = `
                <span class="dash-kpi-title">Freezer 3</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">Corredor 3</span>
                <span class="dash-kpi-detalhes">${dadosmocados.sensor3}ºC às ${r[0].freezer_dataHora}</span>
            `
        } else {
            status = `Normal`
            dash_freezer_3.className = `dash-kpis-item`
            dash_freezer_3.innerHTML = `
                <span class="dash-kpi-title">Freezer 3</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">Corredor 3</span>
                <span class="dash-kpi-detalhes">${dadosmocados.sensor3}ºC às ${r[0].freezer_dataHora}</span>
            `
        }
        if (dadosmocados.sensor4 > 7 || dadosmocados.sensor4 < 2) {
            status = `Alerta`
            dash_freezer_4.className = `dash-kpis-item-alert`
            dash_freezer_4.innerHTML = `
                <span class="dash-kpi-title">Freezer 4</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">Corredor 4</span>
                <span class="dash-kpi-detalhes">${dadosmocados.sensor4}ºC às ${r[0].freezer_dataHora}</span>
            `
        } else {
            status = `Normal`
            dash_freezer_4.className = `dash-kpis-item`
            dash_freezer_4.innerHTML = `
                <span class="dash-kpi-title">Freezer 4</span>
                <span class="dash-kpi-status">Status: ${status}</span>
                <span class="dash-kpi-corredor">Corredor 4</span>
                <span class="dash-kpi-detalhes">${dadosmocados.sensor4}ºC às ${r[0].freezer_dataHora}</span>
            `
        }
    }
</script>